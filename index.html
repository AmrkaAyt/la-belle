<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Parfume</title>
  <style>
    :root{
      --bg:#f7f7f8;
      --fg:#0b0b0c;
      --muted:#6e6e73;
      --line:#e6e7eb;
      --line-strong:#d9dae0;
      --card:#ffffff;
      --chip:#f2f3f5;
      --chip-text:#171717;
      --accent:#111111;
    }
    *{margin:0;padding:0;box-sizing:border-box}
    html,body{height:100%}
    body{font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue";background:var(--bg);color:var(--fg);line-height:1.6;font-weight:400}
    .container{max-width:1200px;margin:0 auto;padding:0 20px}
    header{padding:22px 0;border-bottom:1px solid var(--line);margin-bottom:28px;background:transparent;position:sticky;top:0;backdrop-filter:saturate(1.2) blur(4px);z-index:5}
    .header-content{display:flex;justify-content:space-between;align-items:center;gap:16px}
    .logo{font-size:18px;font-weight:600;letter-spacing:.06em;text-transform:uppercase}
    .cart-btn,.custom-set-btn{background:var(--card);color:var(--fg);border:1px solid var(--line);padding:10px 16px;border-radius:999px;cursor:pointer;font-size:14px;transition:all .25s ease;position:relative}
    .cart-btn:hover,.custom-set-btn:hover{border-color:var(--line-strong);transform:translateY(-1px)}
    .cart-count{position:absolute;top:-6px;right:-6px;background:var(--accent);color:#fff;width:18px;height:18px;border-radius:50%;display:grid;place-items:center;font-size:11px;font-weight:600}
    .products-grid{display:grid;grid-template-columns:repeat(auto-fill, minmax(240px,1fr));gap:24px;margin:28px 0 64px}
    .product-card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:14px;transition:transform .25s ease, box-shadow .25s ease, border-color .25s ease;cursor:pointer}
    .product-card:hover{transform:translateY(-3px);border-color:var(--line-strong);box-shadow:0 6px 20px rgba(0,0,0,.06)}
    .product-image{width:100%;aspect-ratio:3/4;border-radius:12px;background:#fff;border:1px solid var(--line);display:grid;place-items:center;font-size:44px;color:#888;object-fit:contain;margin-bottom:12px}
    .product-brand{font-size:12px;letter-spacing:.08em;text-transform:uppercase;color:var(--muted);margin-bottom:2px}
    .product-name{font-size:16px;font-weight:600;margin-bottom:6px}
    .product-price-range{font-size:14px}
    .modal{display:none;position:fixed;inset:0;z-index:1000;background:rgba(15,15,18,.55);backdrop-filter:blur(6px)}
    .modal-content{background:var(--card);border:1px solid var(--line);margin:3% auto;border-radius:18px;width:min(980px,94%);max-height:90vh;overflow:auto}
    .modal-header{padding:18px 22px;border-bottom:1px solid var(--line);display:flex;justify-content:space-between;align-items:center}
    .modal-title{font-size:18px;font-weight:600}
    .close{background:transparent;border:none;color:var(--muted);font-size:26px;cursor:pointer;padding:6px}
    .close:hover{color:var(--fg)}
    .modal-body{padding:22px}
    .detail-grid{display:grid;grid-template-columns:1fr 1.2fr;gap:28px}
    .detail-image{background:#fff;border:1px solid var(--line);border-radius:14px;display:grid;place-items:center;aspect-ratio:3/4;font-size:64px;color:#999;overflow:hidden}
    .detail-image img{width:100%;height:100%;object-fit:contain}
    .detail-title{font-size:12px;letter-spacing:.12em;text-transform:uppercase;color:var(--muted);margin:18px 0 8px}
    .detail-content{color:#333}
    .volume-options{display:flex;flex-wrap:wrap;gap:10px}
    .volume-option,.set-option{background:var(--chip);color:var(--chip-text);border:1px solid var(--line);border-radius:999px;padding:8px 12px;font-size:13px;cursor:pointer;transition:all .2s ease;white-space:nowrap}
    .volume-option:hover,.set-option:hover{border-color:var(--line-strong)}
    .volume-option.selected,.set-option.selected{background:var(--accent);color:#fff;border-color:var(--accent)}
    .volume-price,.set-price{display:block;font-size:11px;opacity:.8}
    .current-price{font-size:24px;font-weight:700;margin:18px 0}
    .add-to-cart{width:100%;background:var(--accent);color:#fff;border:none;padding:14px 18px;border-radius:12px;cursor:pointer;font-size:14px;font-weight:600;transition:transform .2s ease, opacity .2s ease}
    .add-to-cart:hover{transform:translateY(-1px);opacity:.95}
    .cart-item{display:flex;justify-content:space-between;align-items:center;padding:18px 0;border-bottom:1px solid var(--line)}
    .cart-item:last-child{border-bottom:none}
    .cart-item-details{font-size:12px;color:var(--muted)}
    .cart-item-price{font-weight:600}
    .quantity-controls{display:flex;align-items:center;gap:12px}
    .quantity-btn{background:var(--card);border:1px solid var(--line);color:var(--fg);width:32px;height:32px;border-radius:8px;cursor:pointer}
    .remove-btn{background:transparent;border:1px solid var(--line);color:var(--muted);padding:6px 10px;border-radius:999px;cursor:pointer;font-size:11px;text-transform:uppercase}
    .total{text-align:center;padding-top:16px;border-top:1px solid var(--line)}
    .total-price{font-size:22px;font-weight:700}
    .share-btn{width:100%;background:var(--card);color:var(--fg);border:1px solid var(--line);padding:12px 16px;border-radius:12px;cursor:pointer;margin-top:14px}
    .empty-cart{text-align:center;color:var(--muted);padding:56px 0}
    @media (max-width: 860px){.detail-grid{grid-template-columns:1fr;gap:18px}.modal-content{width:96%}}
    /* tiny helper for loading */
    .skeleton{display:grid;gap:16px}
    .skeleton .row{height:260px;background:linear-gradient(90deg,#eee,#f6f6f6,#eee);background-size:200% 100%;animation:shimmer 1.2s infinite}
    @keyframes shimmer{0%{background-position:200% 0}100%{background-position:0 0}}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="header-content">
        <div class="logo">Parfume</div>
        <div>
          <button class="custom-set-btn" onclick="openCustomSetModal()">Создать сет</button>
          <button class="cart-btn" onclick="openCart()">Корзина <span class="cart-count" id="cartCount">0</span></button>
        </div>
      </div>
    </header>

    <div class="products-grid" id="productsGrid">
      <div class="skeleton">
        <div class="row"></div>
        <div class="row"></div>
        <div class="row"></div>
      </div>
    </div>
  </div>

  <!-- Модальное окно товара -->
  <div id="productModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title" id="productModalTitle">Детали товара</h2>
        <button class="close" onclick="closeProductModal()">&times;</button>
      </div>
      <div class="modal-body" id="productModalBody"></div>
    </div>
  </div>

  <!-- Модальное окно создания кастомного сета -->
  <div id="customSetModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">Создать сет</h2>
        <button class="close" onclick="closeCustomSetModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="custom-set-section">
          <div class="detail-title">Выберите парфюмы</div>
          <div class="custom-set-grid" id="customSetGrid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:12px"></div>
          <div class="custom-set-controls" style="display:flex;align-items:center;gap:12px;margin-top:12px">
            <label>Объем</label>
            <select id="customSetVolume">
              <option value="2">2мл</option>
              <option value="5">5мл</option>
              <option value="10" selected>10мл</option>
            </select>
            <label>Количество</label>
            <input type="number" id="customSetCount" min="2" max="10" value="3" style="width: 70px;">
            <button onclick="calculateCustomSet()">Рассчитать</button>
          </div>
          <div id="customSetPrice" class="current-price" style="margin-top: 12px;"></div>
          <button class="add-to-cart" id="addCustomSetBtn" onclick="addCustomSetToCart()" style="display:none">Добавить в корзину</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Модальное окно корзины -->
  <div id="cartModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">Корзина</h2>
        <button class="close" onclick="closeCart()">&times;</button>
      </div>
      <div class="modal-body">
        <div id="cartItems"></div>
        <div class="total">
          <div class="total-price"><span id="totalPrice">0</span> ₸</div>
          <button class="share-btn" onclick="shareCart()">Поделиться</button>
          <!-- Доп: быстрые кнопки без бэка -->
          <div style="display:flex;gap:8px;margin-top:8px;justify-content:center">
            <button class="share-btn" style="max-width:240px" onclick="sendWhatsApp()">Отправить в WhatsApp</button>
            <button class="share-btn" style="max-width:240px" onclick="sendTelegram()">Отправить в Telegram</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- CSV parser -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script>
    // ====== НАСТРОЙКА: вставь ссылку на CSV Google Sheets ======
    // Пример: https://docs.google.com/spreadsheets/d/XXXX/export?format=csv&gid=0
    const SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/1Jyrtv0BnD03CBCqCbfF1puSiAVTqG4p-MPSaXCYFOgM/export?format=csv&gid=1821735406";

    // Можно указать номер WhatsApp и username TG для быстрых кнопок
    const WHATSAPP_PHONE = "7701XXXXXXX"; // без "+"
    const TELEGRAM_BOT_OR_USERNAME = ""; // необязательно; если пусто — откроется t.me/share

    // ====== Глобальные состояния ======
    let products = [];
    let cart = [];
    let selectedOptions = {};
    let customSetSelection = [];

    // ====== Утилиты ======
    function rub(n){
      try { return Number(n).toLocaleString('ru-RU'); } catch(e) { return n; }
    }
    function slug(s){
      return (s||"").toLowerCase().replace(/['’]/g,"").replace(/[^a-z0-9а-яё\s-]/gi," ")
        .replace(/\s+/g," ").trim().replace(/\s/g,"_");
    }
    function imagePathFor(p){ return `images/${slug(p.brand)}_${slug(p.name)}.jpg`; }
    function toInt(val){ const d=(val||"").toString().replace(/[^\d]/g,""); return d?parseInt(d,10):null; }
    function normalizeDrive(u){
      if(!u) return "";
      try{
        const url = new URL(u);
        if (url.hostname === "drive.google.com"){
          const m = url.pathname.match(/\/file\/d\/([^/]+)/);
          if (m) return `https://drive.google.com/uc?export=view&id=${m[1]}`;
        }
      }catch(e){}
      return u;
    }

    // ====== Загрузка каталога из Google Sheets (CSV) ======
    async function loadCatalogFromSheet(){
      const grid = document.getElementById('productsGrid');
      try{
        const res = await fetch(SHEET_CSV_URL + (SHEET_CSV_URL.includes('?')?'&':'?') + 't=' + Date.now());
        if (!res.ok) throw new Error('Не удалось загрузить CSV');
        const csv = await res.text();
        const parsed = Papa.parse(csv, { header:true, skipEmptyLines:true });
        const rows = parsed.data;

        products = rows.map((r, i) => {
          const volumes = {};
          [["price_2ml","2"],["price_5ml","5"],["price_10ml","10"],["price_15ml","15"],["price_20ml","20"]]
            .forEach(([col,ml]) => { const v = toInt(r[col]); if(v) volumes[ml]=v; });

          const p = {
            id: i+1,
            brand: r.brand || "",
            name: r.name || "",
            description: r.description_short || `${r.brand||""} ${r.name||""}`,
            fullDescription: r.description_full || "",
            emoji: "🧴",
            notes: { top: r.notes_top||"—", heart: r.notes_heart||"—", base: r.notes_base||"—" },
            season: r.season||"Универсальный",
            longevity: r.longevity||"—",
            sillage: r.sillage||"—",
            volumes,
            sets: {}
          };
          const rawUrl = (r.image_url||"").trim();
          p.image = rawUrl ? normalizeDrive(rawUrl) : imagePathFor(p);
          return p;
        });

        displayProducts();
      }catch(err){
        grid.innerHTML = `<div class="empty-cart">Ошибка загрузки каталога: ${err.message}. Проверь ссылку на CSV.</div>`;
      }
    }

    // ====== Рендер каталога ======
    function displayProducts(){
      const grid=document.getElementById('productsGrid');
      grid.innerHTML='';
      products.forEach(p=>{
        const prices = Object.values(p.volumes||{});
        const minPrice = prices.length? Math.min(...prices) : null;
        const card=document.createElement('div');
        card.className='product-card';
        card.onclick=()=>openProductModal(p.id);
        const src = p.image;
        const fallback = (p.emoji || '🧴').replace(/"/g,'&quot;');
        const priceHtml = minPrice? `от ${rub(minPrice)} ₸` : `Цена по запросу`;
        card.innerHTML=`
          <img class="product-image" src="${src}" alt="${p.name}"
               onerror="this.outerHTML='<div class=\"product-image\">${fallback}</div>'">
          <div class="product-brand">${p.brand}</div>
          <div class="product-name">${p.name}</div>
          <div class="product-price-range">${priceHtml}</div>
        `;
        grid.appendChild(card);
      });
    }

    // ====== Модалка товара ======
    function generateVolumeOptions(product, productId) {
      let html = '';
      const entries = Object.entries(product.volumes||{});
      if(entries.length===0){
        return '<div style="color:#999;font-size:13px">Нет доступных объёмов</div>';
      }
      entries.forEach(([volume, price]) => {
        const isSelected = selectedOptions[productId] && selectedOptions[productId].type === 'volume' && selectedOptions[productId].volume === volume;
        html += `
          <div class="volume-option ${isSelected ? 'selected' : ''}"
               onclick="selectOptionInModal(${productId}, 'volume', '${volume}')">
            ${volume}мл
            <span class="volume-price">${rub(price)}₸</span>
          </div>
        `;
      });
      return html;
    }
    function generateSetOptions(product, productId) {
      const sets = product.sets || {};
      const keys = Object.keys(sets);
      if(!keys.length) return '';
      let html = '<div class="detail-title">Сеты</div><div class="volume-options" id="setOptions-'+productId+'">';
      keys.forEach((setKey) => {
        const setData = sets[setKey];
        const isSelected = selectedOptions[productId] && selectedOptions[productId].type === 'set' && selectedOptions[productId].set === setKey;
        html += `
          <div class="set-option ${isSelected ? 'selected' : ''}"
               onclick="selectOptionInModal(${productId}, 'set', '${setKey}')">
            <span class="set-description">${setData.description}</span>
            <span class="set-price">${rub(setData.price)}₸</span>
          </div>
        `;
      });
      html += '</div>';
      return html;
    }
    function getCurrentPrice(productId) {
      const product = products.find(p => p.id === productId);
      const options = selectedOptions[productId];
      const vols = product?.volumes || {};
      if (!options) return Object.values(vols)[0] || 0;
      if (options.type === 'volume') return vols[options.volume] || 0;
      const s = product.sets?.[options.set];
      return s ? s.price : 0;
    }
    function selectOptionInModal(productId, type, value) {
      if (!selectedOptions[productId]) selectedOptions[productId] = {type:'volume'};
      selectedOptions[productId].type = type;
      if (type === 'volume') selectedOptions[productId].volume = value; else selectedOptions[productId].set = value;
      const product = products.find(p => p.id === productId);
      const volEl = document.getElementById(`volumeOptions-${productId}`);
      if (volEl) volEl.innerHTML = generateVolumeOptions(product, productId);
      const setEl = document.getElementById(`setOptions-${productId}`);
      if (setEl && product.sets) setEl.innerHTML = generateSetOptions(product, productId);
      const priceEl = document.getElementById(`currentPrice-${productId}`);
      if (priceEl) priceEl.textContent = rub(getCurrentPrice(productId)) + ' ₸';
    }

    function openProductModal(productId){
      const product=products.find(p=>p.id===productId);
      if(!product) return;
      if(!selectedOptions[productId]){
        const firstVol = Object.keys(product.volumes||{})[0];
        selectedOptions[productId] = {type:'volume', volume:firstVol, set:Object.keys(product.sets||{})[0]};
      }
      document.getElementById('productModalTitle').textContent = `${product.brand} ${product.name}`;
      const body=document.getElementById('productModalBody');
      const imgSrc = product.image;
      const modalImg = `<img src="${imgSrc}" alt="${product.name}" onerror="this.outerHTML='${(product.emoji||'🧴')}'"/>`;
      const setsHtml = generateSetOptions(product, productId); // может быть пустым
      body.innerHTML=`
        <div class="detail-grid">
          <div class="detail-image">${modalImg}</div>
          <div>
            <div class="detail-title">Описание</div>
            <div class="detail-content" style="margin-bottom:12px">${product.fullDescription || product.description}</div>
            <div class="detail-title">Пирамида</div>
            <div class="detail-content" style="margin-bottom:14px">
              <div><strong>Верхние:</strong> ${product.notes.top}</div>
              <div><strong>Сердце:</strong> ${product.notes.heart}</div>
              <div><strong>База:</strong> ${product.notes.base}</div>
            </div>
            <div class="detail-title">Объём</div>
            <div class="volume-options" id="volumeOptions-${productId}">${generateVolumeOptions(product, productId)}</div>
            ${setsHtml}
            <div class="current-price" id="currentPrice-${productId}">${rub(getCurrentPrice(productId))} ₸</div>
            <button class="add-to-cart" onclick="addToCartFromModal(${productId})">Добавить в корзину</button>
          </div>
        </div>`;
      document.getElementById('productModal').style.display='block';
    }
    function closeProductModal(){ document.getElementById('productModal').style.display='none'; }

    // ====== Кастомный сет ======
    function generateCustomSetGrid() {
      const grid = document.getElementById('customSetGrid');
      grid.innerHTML = '';
      products.forEach(product => {
        const item = document.createElement('div');
        item.className = 'custom-item';
        item.style.cssText = 'border:1px solid var(--line);border-radius:12px;padding:10px;background:var(--card);cursor:pointer;display:grid;gap:6px;place-items:start';
        item.onclick = () => toggleCustomSetItem(product.id);
        const src = product.image;
        const fallback = (product.emoji||'🧴').replace(/"/g,'&quot;');
        item.innerHTML = `
          <div style="width:100%;aspect-ratio:3/4;border-radius:8px;border:1px solid var(--line);overflow:hidden;display:grid;place-items:center">
            <img src="${src}" alt="${product.name}" style="width:100%;height:100%;object-fit:contain" onerror="this.outerHTML='<div style=\'font-size:28px;color:#888\'>${fallback}</div>'" />
          </div>
          <div style="font-weight:600;font-size:12px;">${product.name}</div>
          <div style="font-size:10px;color:#888;">${product.brand}</div>
        `;
        grid.appendChild(item);
      });
    }
    function toggleCustomSetItem(productId) {
      const index = customSetSelection.indexOf(productId);
      if (index > -1) customSetSelection.splice(index, 1); else customSetSelection.push(productId);
      const items = document.querySelectorAll('#customSetGrid .custom-item');
      items.forEach((item, idx) => {
        const sel = customSetSelection.includes(products[idx].id);
        item.style.borderColor = sel? 'var(--accent)' : 'var(--line)';
      });
      calculateCustomSet();
    }
    function calculateCustomSet() {
      const volume = document.getElementById('customSetVolume').value;
      const count = parseInt(document.getElementById('customSetCount').value, 10);
      const priceDiv = document.getElementById('customSetPrice');
      const addBtn = document.getElementById('addCustomSetBtn');
      if (customSetSelection.length === 0){ priceDiv.textContent=''; addBtn.style.display='none'; return; }
      if (customSetSelection.length > count){ priceDiv.textContent = `Выбрано слишком много (${customSetSelection.length}/${count})`; addBtn.style.display='none'; return; }
      let totalPrice = 0;
      customSetSelection.forEach(productId => { const p = products.find(x=>x.id===productId); totalPrice += (p.volumes?.[volume]||0); });
      if (customSetSelection.length < count){
        const remaining = count - customSetSelection.length;
        const avgPrice = totalPrice / customSetSelection.length;
        totalPrice += avgPrice * remaining;
      }
      priceDiv.textContent = `${rub(Math.round(totalPrice))} ₸`;
      addBtn.style.display = 'block';
    }
    function addCustomSetToCart() {
      const volume = document.getElementById('customSetVolume').value;
      const count = document.getElementById('customSetCount').value;
      if (customSetSelection.length === 0) return;
      const selectedProducts = customSetSelection.map(id => products.find(p => p.id === id));
      let totalPrice = 0;
      selectedProducts.forEach(product => { totalPrice += (product.volumes?.[volume]||0); });
      const itemKey = `custom-set-${Date.now()}`;
      const productNames = selectedProducts.map(p => p.name).join(', ');
      cart.push({ key:itemKey, id:'custom-set', name:'Кастомный сет', brand:`${count} флаконов по ${volume}мл`, emoji:'🎨', description:productNames, type:'custom-set', price:Math.round(totalPrice), quantity:1 });
      updateCartCount();
      closeCustomSetModal();
    }
    function openCustomSetModal(){ generateCustomSetGrid(); document.getElementById('customSetModal').style.display='block'; }
    function closeCustomSetModal(){ document.getElementById('customSetModal').style.display='none'; customSetSelection = []; }

    // ====== Корзина ======
    function addToCartFromModal(productId){ addToCart(productId); closeProductModal(); }
    function addToCart(productId){
      const product = products.find(p => p.id === productId);
      const options = selectedOptions[productId];
      const price = getCurrentPrice(productId);
      let itemKey, itemDescription;
      if (options?.type === 'set'){ itemKey = `${productId}-set-${options.set}`; itemDescription = product.sets[options.set].description; }
      else { const v = options?.volume || Object.keys(product.volumes||{})[0] || '—'; itemKey = `${productId}-volume-${v}`; itemDescription = `${v}мл`; }
      const existingItem = cart.find(item => item.key === itemKey);
      if (existingItem) existingItem.quantity += 1; else cart.push({ key:itemKey, id:productId, name:product.name, brand:product.brand, emoji:product.emoji||'🧴', description:itemDescription, type:(options?.type||'volume'), price:price, quantity:1 });
      updateCartCount();
    }
    function updateCartCount(){ const count = cart.reduce((s,i)=>s+i.quantity,0); document.getElementById('cartCount').textContent = count; }
    function openCart(){ displayCartItems(); document.getElementById('cartModal').style.display = 'block'; }
    function closeCart(){ document.getElementById('cartModal').style.display = 'none'; }
    function displayCartItems(){
      const cartItems = document.getElementById('cartItems');
      if (cart.length === 0){ cartItems.innerHTML = '<div class="empty-cart">Корзина пуста</div>'; document.getElementById('totalPrice').textContent = '0'; return; }
      cartItems.innerHTML = '';
      let total = 0;
      cart.forEach(item => {
        const itemTotal = item.price * item.quantity; total += itemTotal;
        const cartItem = document.createElement('div'); cartItem.className = 'cart-item';
        cartItem.innerHTML = `
          <div class="cart-item-info">
            <div class="cart-item-name">${item.emoji} ${item.name}</div>
            <div class="cart-item-details">${item.brand}</div>
            <div class="cart-item-details">${item.description}</div>
            <div class="cart-item-price">${rub(item.price)} ₸</div>
          </div>
          <div class="quantity-controls">
            <button class="quantity-btn" onclick="changeQuantity('${item.key}', -1)">−</button>
            <span style="color:#111;font-weight:600;min-width:18px;text-align:center">${item.quantity}</span>
            <button class="quantity-btn" onclick="changeQuantity('${item.key}', 1)">+</button>
            <button class="remove-btn" onclick="removeFromCart('${item.key}')">Удалить</button>
          </div>`;
        cartItems.appendChild(cartItem);
      });
      document.getElementById('totalPrice').textContent = rub(total);
    }
    function changeQuantity(itemKey, change){ const item = cart.find(i=>i.key===itemKey); if(!item) return; item.quantity += change; if (item.quantity <= 0) removeFromCart(itemKey); else { displayCartItems(); updateCartCount(); } }
    function removeFromCart(itemKey){ cart = cart.filter(i=>i.key!==itemKey); displayCartItems(); updateCartCount(); }

    // ====== Поделиться/отправить заказ (без бэка) ======
    function buildOrderMessage(){
      if (cart.length === 0) return 'Корзина пуста';
      let message = 'ЗАКАЗ ПАРФЮМЕРИИ\n\n'; let total = 0;
      cart.forEach((item, i) => { const itemTotal = item.price * item.quantity; total += itemTotal; message += `${i+1}. ${item.name}\n${item.brand}\n${item.description}\n${item.quantity} шт. × ${rub(item.price)} ₸ = ${rub(itemTotal)} ₸\n\n`; });
      message += `ИТОГО: ${rub(total)} ₸`;
      return message;
    }
    function shareCart(){
      const message = buildOrderMessage();
      if (cart.length === 0){ alert('Корзина пуста'); return; }
      if (navigator.share){ navigator.share({ title:'Заказ парфюмерии', text: message }).catch(()=>copyToClipboard(message)); }
      else { copyToClipboard(message); }
    }
    function copyToClipboard(text){ navigator.clipboard.writeText(text).then(()=>alert('Заказ скопирован в буфер обмена')).catch(()=>{ const ta=document.createElement('textarea'); ta.value=text; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta); alert('Заказ скопирован в буфер обмена'); }); }
    function sendWhatsApp(){ const msg=buildOrderMessage(); if (cart.length===0) return alert('Корзина пуста'); const phone=WHATSAPP_PHONE||''; const url = phone? `https://wa.me/${phone}?text=${encodeURIComponent(msg)}` : `https://api.whatsapp.com/send?text=${encodeURIComponent(msg)}`; window.open(url, '_blank'); }
    function sendTelegram(){ const msg=buildOrderMessage(); if (cart.length===0) return alert('Корзина пуста'); let url = `https://t.me/share/url?text=${encodeURIComponent(msg)}`; if (TELEGRAM_BOT_OR_USERNAME){ url = `https://t.me/${TELEGRAM_BOT_OR_USERNAME}?start=${encodeURIComponent(msg.slice(0,512))}`; } window.open(url, '_blank'); }

    // ====== Окна/закрытие ======
    window.onclick = function(event){ ['cartModal','productModal','customSetModal'].forEach(id=>{ const modal=document.getElementById(id); if (event.target===modal) modal.style.display='none'; }); }

    // ====== Старт ======
    document.addEventListener('DOMContentLoaded', loadCatalogFromSheet);
  </script>
</body>
</html>
